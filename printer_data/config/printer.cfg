[include mainsail.cfg]

[mcu]
#serial: /dev/serial/by-id/usb-Klipper_rp2040_504450612065BD1C-if00
serial: /dev/ttyAMA0

# ========= Printer =========
[printer]
kinematics: cartesian
max_velocity: 600
max_accel: 2000
square_corner_velocity: 5.0
# Trick Klipper: disable Z movement (0 height)
max_z_velocity: 1
max_z_accel: 1

# ========= X Axis (Slider) =========
[stepper_x]
step_pin: gpio11
dir_pin: !gpio10
enable_pin: !gpio12
microsteps: 16
rotation_distance: 40.0      # adjust for belt or leadscrew
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: 0
position_endstop: 0
position_max: 1100             # slider length in mm
homing_speed: 40
homing_retract_dist: 0
homing_positive_dir: false

[tmc2209 stepper_x]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 0
diag_pin: ^gpio4
run_current: 0.60
stealthchop_threshold: 0
driver_SGTHRS: 50             # higher = more sensitive (try 40–80 range)

# ========= Y Axis (Pan) =========
[stepper_y]
step_pin: gpio6
dir_pin: !gpio5
enable_pin: !gpio7
microsteps: 16
rotation_distance: 40.0     # degrees per motor rev, adjust for gearing
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_endstop: 0
position_min: -180
position_max: 180             # pan range
homing_speed: 20
homing_retract_dist: 0
homing_positive_dir: false

[tmc2209 stepper_y]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 2
diag_pin: ^gpio3
run_current: 0.70
stealthchop_threshold: 0
driver_SGTHRS: 50

# ========= Dummy Z (required placeholder) =========
# This prevents Klipper from complaining that no Z axis exists
[stepper_z]
step_pin: gpio19
dir_pin: gpio28
enable_pin: !gpio2
microsteps: 16
rotation_distance: 8
endstop_pin: ^gpio25
position_endstop: 0.0
position_max: 250

# ========= Macros =========
[idle_timeout]
timeout: 60       # seconds before idle triggers
gcode:
  SET_TMC_CURRENT STEPPER=stepper_x HOLD_CURRENT=0.10
  SET_TMC_CURRENT STEPPER=stepper_y HOLD_CURRENT=0.10

# ========= Sensorless Homing Mode Toggle =========
[gcode_macro SENSORLESS_HOMING_ON]
description: "Enable SpreadCycle for reliable sensorless homing"
gcode:
  M118 Enabling SpreadCycle mode for homing...
  # X axis
  SET_TMC_FIELD STEPPER=stepper_x FIELD=TPWMTHRS VALUE=0
  # Y axis
  SET_TMC_FIELD STEPPER=stepper_y FIELD=TPWMTHRS VALUE=0

[gcode_macro SENSORLESS_HOMING_OFF]
description: "Re-enable quiet StealthChop mode after homing"
gcode:
  M118 Enabling StealthChop for quiet operation...
  # X axis
  SET_TMC_FIELD STEPPER=stepper_x FIELD=TPWMTHRS VALUE=999999
  # Y axis
  SET_TMC_FIELD STEPPER=stepper_y FIELD=TPWMTHRS VALUE=999999

[gcode_macro MOVE_BOTH]
description: "Move slider (X) and pan (Y) together with angle calculation"
gcode:
  {% set x = params.DISTANCE|default(1000)|float %}
  {% set angle = params.ANGLE|default(75)|float %}
  {% set feed = params.FEEDRATE|default(3000)|float %}
  
  {% if angle >= 0 %}
    {% set y = angle * 0.421 %}  # Positive: Y40 = 95°
  {% else %}
    {% set y = angle * 0.4 %}    # Negative: Y36 = 90°
  {% endif %}

  SENSORLESS_HOMING_ON
  G90
  G1 X{x} Y{y} F{feed}
  SENSORLESS_HOMING_OFF

[gcode_macro SLIDE_MOVE]
description: "Move slider to X position (mm)"
gcode:
  SENSORLESS_HOMING_ON
  {% set pos = params.X|float %}
  {% set feed = params.FEEDRATE|default(1500)|float %}
  G90
  G1 X{pos} F{feed}
  G4 P2000    # wait 2 seconds
  M84
  SENSORLESS_HOMING_OFF

[gcode_macro PAN_MOVE]
description: "Rotate pan axis to absolute angle (+ or -)"
gcode:
  {% set angle = params.ANGLE|float %}
  {% set feed = params.F|default(1000)|float %}

  {% if angle >= 0 %}
    {% set distance = angle * 0.421 %}  # Positive: Y40 = 95°
  {% else %}
    {% set distance = angle * 0.4 %}    # Negative: Y36 = 90°
  {% endif %}

  M118 Moving to angle {angle}° (Y={distance}mm)
  G90
  G1 Y{distance} F{feed}

[gcode_macro PAN_HOME]
description: "Return pan axis to zero position"
gcode:
  {% set feed = 1500.0 %}
  G90
  G1 Y0 F{feed}

[gcode_macro SLIDE_HOME]
gcode:
  SENSORLESS_HOMING_ON
  G28 X
  SENSORLESS_HOMING_OFF
  M118 Slider homed

[delayed_gcode PAN_AUTO_HOME]
initial_duration: 2
gcode:
  SET_KINEMATIC_POSITION Y=0

[force_move]
enable_force_move: true
